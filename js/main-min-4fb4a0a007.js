var xsyh=angular.module("xsyh",["ionic"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","$ionicConfigProvider","$compileProvider","$animateProvider",function(e,t,o,r,s,n){t.when("","/home"),e.state("home",{url:"/home",views:{mainContent:{templateUrl:"template/home/home.html?tk="+(new Date).getTime(),controller:"homeCtrl"}}}).state("shoppingCart",{url:"/shoppingCart",views:{mainContent:{templateUrl:"template/shoppingCart/shoppingCart.html?tk="+(new Date).getTime(),controller:"shoppingCartCtrl"}}}).state("pay",{url:"/pay?from",cache:!1,views:{mainContent:{templateUrl:"template/pay/pay.html?tk="+(new Date).getTime(),controller:"payCtrl"}}}).state("list",{url:"/list?from&storeId",views:{mainContent:{templateUrl:"template/list/list.html?tk="+(new Date).getTime(),controller:"listCtrl"}}}).state("my",{url:"/my",views:{mainContent:{templateUrl:"template/my/my.html?tk="+(new Date).getTime(),controller:"myCtrl"}}}).state("coupons",{url:"/coupons?from",cache:!1,views:{mainContent:{templateUrl:"template/coupons/coupons.html?tk="+(new Date).getTime(),controller:"couponsCtrl"}}}).state("commodity-detail",{url:"/commodityDetail?commodityId",views:{mainContent:{templateUrl:"template/commodity/detail.html?tk="+(new Date).getTime(),controller:"detailCtrl"}}}).state("order",{url:"/order?orderType",views:{mainContent:{templateUrl:"template/order/order.html?tk="+(new Date).getTime(),controller:"orderCtrl"}}}).state("order-detail",{url:"/order/detail?orderId",cache:!1,params:{orderInfo:null,from:null},views:{mainContent:{templateUrl:"template/order/orderInfo.html?tk="+(new Date).getTime(),controller:"orderInfoCtrl"}}}).state("commodityGroup",{url:"/commodityGroup?activityId",views:{mainContent:{templateUrl:"template/commodityGroup/commodityGroup.html?tk="+(new Date).getTime(),controller:"commodityGroupCtrl"}}}).state("groupInfo",{url:"/groupInfo?groupMealId",views:{mainContent:{templateUrl:"template/groupInfo/groupInfo.html?tk="+(new Date).getTime(),controller:"groupInfoCtrl"}}}).state("address",{url:"/address?from",views:{mainContent:{templateUrl:"template/address/address.html?tk="+(new Date).getTime(),controller:"addressCtrl"}}}).state("FAQ",{url:"/FAQ",views:{mainContent:{templateUrl:"template/FAQ/FAQ.html?tk="+(new Date).getTime()}}}).state("posScan",{url:"/posScan?orderNumber&storeId",views:{mainContent:{templateUrl:"template/posScan/posScan.html?tk="+(new Date).getTime(),controller:"posScanCtrl"}}}).state("activity",{url:"/activity?activityId",views:{mainContent:{templateUrl:"template/activity/activity.html?tk="+(new Date).getTime(),controller:"activityCtrl"}}}),n.classNameFilter(/^((?!(repeat-modify)).)*$/),s.debugInfoEnabled(!1),r.views.transition("none")}]).controller("mainCtrl",["$scope","$state","$http","$timeout","$ionicModal","$rootScope","$ionicLoading","$ionicPopup","$ionicScrollDelegate","$ionicBackdrop","$stateParams","$q",function($scope,$state,$http,$timeout,$ionicModal,$rootScope,$ionicLoading,$ionicPopup,$ionicScrollDelegate,$ionicBackdrop,$stateParams,$q){$scope.wxCheckSignHost=location.href.split("#")[0],$scope.imgRoot="",$scope.shoppingCart=[],$scope.shoppingCartTotalNum=0,$scope.shoppingCartTotalPrice=0,$scope.currItem={},$scope.currStore={},$scope.userInfo={},$scope.order={takeType:1},$scope.orderType=1,$scope.selectedDistribution={},$scope.alertMsg="",$scope.exchangeDate="",$scope.exchangeTime="",$scope.mealInfoList=[],$scope.categoryList=[],$scope.totalCommodityList=[],$scope.dateList=[],$scope.timeList=[],$scope.currFooterMenu=0,$scope.currCoupons={},$scope.currBusiness={},$scope.currAddress={},$scope.itemHeight=90,$scope.itemTabHeight=30,$scope.storeListScroll=null,$scope.activityInfo={},$scope.shareToPromiseList=[];var shopCartEleCR=null,flyEle=null,payError=0,configError=0;$scope.go=function(e,t){if(angular.isNumber(e))history.back(e);else{if(!$state.is("home")&&!$state.is("my")&&("shoppingCart"==e||"pay"==e)&&$scope.shoppingCartTotalPrice<=0)return;$state.go(e,t||{})}},$scope.stateEqual=function(stateName){return eval("var reg = /^#\\/"+stateName.replace("/","\\/")+"(?=\\?|$)/"),reg.test(location.hash)},$scope.closeMask=function(){$scope.activityInfo.showShareMask=!1},$scope.initMutilScrollPopup=function(){$scope.activeIndexList&&$scope.activeIndexList.forEach(function(e,t){if(t!=$scope.scrollSource.length-1){$scope.scrollSource=[],$scope.scrollSource.push($scope.dataSource);for(var o=!0;o;)$scope.scrollSource.slice(-1)[0][e].list&&$scope.scrollSource.slice(-1)[0][e].list.length>0?$scope.scrollSource.push($scope.scrollSource.slice(-1)[0][e].list):o=!1}$scope.scrollSource[t].forEach(function(t,o){o==e?t.selected=!0:t.selected=!1}),$timeout(function(){$ionicScrollDelegate.$getByHandle("scroll"+t).scrollTo(null,40*e,!0)},50)})},$scope.$watch("activeIndexList",function(){$scope.initMutilScrollPopup()},!0),$scope.changeActiveIndex=function(e,t){$scope.activeIndexList[e]=t,e!=$scope.activeIndexList.length-1&&$scope.activeIndexList.forEach(function(t,o,r){o>e&&(r[o]=0)})},$scope.closeMutilScrollPopup=function(){$ionicBackdrop.release(),$scope.showMutilScroll=!1},$scope.showMutilScrollPopup=function(e){return $scope.scrollSource=[],$scope.activeIndexList=[],$scope.success=e.success,$scope.dataSource=e.dataSource,$scope.dataSource.forEach(function(t,o){t.value==e.activeIndexList[0]&&($scope.activeIndexList.push(o),t.list.forEach(function(t,o){t.value==e.activeIndexList[1]&&$scope.activeIndexList.push(o)}))}),0==$scope.activeIndexList.length?void $scope.showComnPopup({message:"默认值为空!",type:"toast"}):($ionicBackdrop.retain(),$scope.showMutilScroll=!0,void $scope.initMutilScrollPopup())},$scope.MutilScrollPopupConfirm=function(){var e=[];$scope.activeIndexList.forEach(function(t,o){e.push($scope.scrollSource[o][t])}),$scope.closeMutilScrollPopup(),$scope.success(e)},$rootScope.$on("$stateChangeStart",function(e,t,o,r,s){if("home"==r.name&&"order-detail"==t.name&&e.preventDefault(),"shoppingCart"==t.name){$scope.initCart();var n=0;$scope.mealInfoList.forEach(function(e){e.itemList.length>0&&n++}),1==n&&"home"!=r.name&&(e.preventDefault(),$scope.go("pay"))}"order-detail"==r.name&&($scope.categoryList.forEach(function(e){e.itemList=[]}),$scope.currCoupons={},$scope.currBusiness={},$scope.currUserAddress={},$scope.shoppingCart.length>0&&($scope.shoppingCart.forEach(function(e){delete e.count}),$scope.shoppingCart=[],$scope.shoppingCartTotalNum=0,$scope.shoppingCartTotalPrice=0),"pay"==t.name&&(e.preventDefault(),$scope.go("home")))}),$scope.enter=function(e,t){$scope.currFooterMenu=t,"order"==e?$state.go(e,{orderType:"nopay"}):$scope.go(e)},$ionicModal.fromTemplateUrl("storeAddress.html",{scope:$scope,animation:"slide-in-left"}).then(function(e){$scope.addressModal=e}),$scope.getCurrentPosition=function(){navigator.geolocation.getCurrentPosition(function(e){$scope.getNearbyStore(e.coords)},function(e){1==e.code?$scope.showComnPopup({message:"用户拒绝授予位置信息,请手动选择门店!",type:"toast"}):2==e.code?$scope.showComnPopup({message:"定位失败,请手动选择门店!",type:"toast"}):3==e.code&&$scope.showComnPopup({message:"获取用户位置超时!",type:"toast"}),$scope.showNearbyStore=!1,$scope.addressModal.show(),$scope.currDistrictIndex||($scope.currDistrictIndex=0)},{timeout:5e3,maximumAge:6e4})},$scope.getNearbyStore=function(e){$http.post("/store/nearby",{lat:e.latitude,lng:e.longitude}).success(function(e,t,o,r){0==e.statusCode?($scope.nearbyStoreList=[],e.data.forEach(function(e){$scope.storeList.forEach(function(t){e.storeId==t.storeId&&(t.distance=e.distance,$scope.nearbyStoreList.push(t))})}),$scope.showNearbyStore=$scope.nearbyStoreList.length>0,$scope.addressModal.show(),$scope.currDistrictIndex||($scope.currDistrictIndex=0)):$scope.showComnPopup({message:e.statusMessage,type:"alert"})})},$scope.openAddressModal=function(){$scope.getCurrentPosition()},$scope.closeAddressModal=function(e){$scope.currStore=e,$scope.refreshView(),$scope.addressModal.hide()},$scope.changeStoreList=function(e){$scope.currDistrictIndex=e,$scope.storeKey="",$scope.storeListScroll||($scope.storeListScroll=$ionicScrollDelegate.$getByHandle("storeListScroll")),$scope.storeListScroll&&$scope.storeListScroll.scrollTop(!0)},$scope.getConfig=function(){$http.post("/index/getConfig",{lon:0,lat:0}).success(function(e,t,o,r){0==e.statusCode?($scope.imgRoot=e.data.adminUrl,$scope.categoryListBak=e.data.categoryList,$scope.mealInfoList=e.data.mealInfoList,$scope.dateList=e.data.orderDateResponseItemList,$scope.timeList=e.data.timeList,e.data.memberInfo&&($scope.userInfo=e.data.memberInfo,$scope.userInfo.contacts&&($scope.order.cellPhone=e.data.memberInfo.contacts)),$scope.storeList=e.data.storeList,$scope.districtStoreList=e.data.districtStoreList,$scope.districtStoreList.forEach(function(e){e.count=e.storeIdList.length,e.storeList=[],e.storeIdList.forEach(function(t){$scope.storeList.forEach(function(o){t==o.storeId&&e.storeList.push(o)})})}),$scope.districtStoreList.sort(function(e,t){return-(e.count-t.count)}),e.data.defaultAddress&&$scope.storeList.forEach(function(t){t.storeAddressList.some(function(t){return t.addressId==e.data.defaultAddress.storeAddressId})&&(t.defaultAddress=e.data.defaultAddress)}),location.hash.indexOf("storeId")>=0&&(e.data.commodityOrder={},e.data.commodityOrder.storeId=location.hash.replace(/.*[\?|\&]storeId\=([^\&]*)\&?.*/,"$1")),e.data.commodityOrder&&e.data.commodityOrder.storeId&&($scope.currStore=$scope.storeList.filter(function(t,o,r){return t.storeId==e.data.commodityOrder.storeId&&1==t.online})[0],$scope.currStore||(e.data.commodityOrder=null)),e.data.commodityOrder&&e.data.commodityOrder.storeId?$http.post("/goods/getNewCommodityList",{storeId:$scope.currStore.storeId,pageSize:0}).success(function(e,t,o,r){0==e.statusCode&&($scope.totalCommodityList=e.data||[],$scope.stateEqual("list")?$rootScope.$broadcast("initItemList",{storeId:$scope.currStore.storeId}):$scope.stateEqual("home")?$rootScope.$broadcast("initHomePage",{storeId:$scope.currStore.storeId}):$scope.stateEqual("order/detail")?$rootScope.$broadcast("initOrderInfo"):$scope.stateEqual("commodityDetail")?$rootScope.$broadcast("initCommodityDetail"):$scope.stateEqual("commodityGroup")?$rootScope.$broadcast("initCommodityGroup"):$scope.stateEqual("order")?$rootScope.$broadcast("initOrder"):$scope.stateEqual("posScan")?$rootScope.$broadcast("initPosScan"):$scope.stateEqual("activity")&&$rootScope.$broadcast("initActivity"))}):($scope.stateEqual("order")||$scope.stateEqual("order/detail")||$scope.openAddressModal(),$scope.stateEqual("order/detail")?$rootScope.$broadcast("initOrderInfo"):$scope.stateEqual("order")&&$rootScope.$broadcast("initOrder"))):alert("statusCode:"+e.statusCode+"statusMessage:"+e.statusMessage)}).error(function(e,t,o,r){0==t?(configError++,3>=configError?$scope.getConfig():$scope.showComnPopup({message:"当前网络异常,请重试!",type:"alert",alert:function(){configError=0,$scope.getConfig()}})):$scope.showComnPopup({message:"errorStatus:"+t+" errorData:"+angular.toJson(e),type:"alert"})})},$scope.getConfig(),$scope.calcCurrViewShoppingCartNum=function(){$scope.shoppingCartTotalNum=0,$scope.shoppingCartTotalPrice=0,$state.is("shoppingCart")||$state.is("pay")?($scope.shoppingCart.forEach(function(e,t,o){e.checked&&($scope.shoppingCartTotalNum+=e.count,$scope.shoppingCartTotalPrice+=e.count*(100*e.promotion)/100)}),$scope.mealInfoList.forEach(function(e,t,o){e.selectedCount=0,e.totalPrice=0,e.itemList.forEach(function(t){e.selectedCount+=t.count,e.totalPrice+=t.count*(100*t.promotion)/100})})):$scope.shoppingCart.forEach(function(e,t,o){$scope.shoppingCartTotalNum+=e.count,$scope.shoppingCartTotalPrice+=e.count*(100*e.promotion)/100})},$scope.$watch("shoppingCart",function(){$scope.calcCurrViewShoppingCartNum()},!0),$scope.watchCategoryList=function(e){$scope.$watch("categoryList["+e+"]",function(){$scope.categoryList[e].selectedCount=0,$scope.categoryList[e].itemList.forEach(function(t,o,r){t.count&&($scope.categoryList[e].selectedCount+=t.count)})},!0)},$scope.addItem=function(e,t){t&&t.stopPropagation(),e.count||(e.count=0);var o=t.currentTarget.getBoundingClientRect();shopCartEleCR||(shopCartEleCR=document.getElementsByClassName("icon-basket")[0].getBoundingClientRect());var r=document.createElement("img");r.className="flyE",r.style.left=o.left+"px",r.style.top=o.top+"px",r.src=$scope.imgRoot+e.scan,document.body.appendChild(r),$timeout(function(){r.style.visibility="hidden",r.style.left=shopCartEleCR.left+"px",r.style.top=shopCartEleCR.top+"px",e.count++,$scope.shoppingCart.length>0?$scope.shoppingCart.some(function(t,o,r){return t===e})||$scope.shoppingCart.push(e):$scope.shoppingCart.push(e)},50)},$scope.removeItem=function(e,t){if(t&&t.stopPropagation(),1==e.count)if($state.is("shoppingCart")){var o={title:"是否确认删除所选餐品?",type:"confirm"};o.confirm=function(){$scope.shoppingCart.splice($scope.shoppingCart.indexOf(e),1),$scope.mealInfoList.forEach(function(t,o,r){t.itemList.some(function(t){return t===e})&&t.itemList.splice(t.itemList.indexOf(e),1)}),e.count=0},$scope.showComnPopup(o)}else $scope.shoppingCart.splice($scope.shoppingCart.indexOf(e),1),e.count=0;else e.count--},$scope.refreshView=function(){$scope.currBusiness={},$scope.currCoupons={},$scope.currUserAddress={};for(var e=0;e<$scope.categoryList.length;e++)$scope.categoryList[e].itemList=[];$scope.shoppingCart.length>0&&($scope.shoppingCart=[],$scope.shoppingCartTotalNum=0,$scope.shoppingCartTotalPrice=0),$http.post("/goods/getNewCommodityList",{storeId:$scope.currStore.storeId,pageSize:0}).success(function(e,t,o,r){0==e.statusCode&&($scope.totalCommodityList=e.data||[],$scope.stateEqual("list")?$rootScope.$broadcast("initItemList",{storeId:$scope.currStore.storeId}):$scope.stateEqual("home")?$rootScope.$broadcast("initHomePage",{storeId:$scope.currStore.storeId}):$scope.stateEqual("commodityDetail")?$rootScope.$broadcast("initCommodityDetail"):$scope.stateEqual("commodityGroup")?$rootScope.$broadcast("initCommodityGroup"):$scope.stateEqual("order")?$rootScope.$broadcast("initOrder"):$scope.stateEqual("activity")&&$rootScope.$broadcast("initActivity"))})},$scope.showComnPopup=function(e){"alert"==e.type?$ionicPopup.show({title:"温馨提示",scope:$scope,cssClass:"comn-alert",template:e.message,buttons:[{text:"确定",onTap:function(e){return!0}}]}).then(function(){e.alert&&e.alert()}):"confirm"==e.type?$ionicPopup.show({title:e.title,scope:$scope,cssClass:"comn-confirm",buttons:[{text:"确定",onTap:function(e){return!0}},{text:"取消",onTap:function(e){return!1}}]}).then(function(t){t?e.confirm():e.cancel&&e.cancel()}):"toast"==e.type&&$ionicLoading.show({hideOnStateChange:!0,template:e.message||"",noBackdrop:e.noBackdrop||!0,duration:e.duration||1500})},$scope.storeFilter=function(e){return $scope.storeKey&&0!=$scope.storeKey.length?$scope.storeKey.length>0?1==e.online&&(e.name.indexOf($scope.storeKey)>=0||e.address.indexOf($scope.storeKey)>=0):void 0:1==e.online},$scope.initCart=function(){var e=!1;$scope.shoppingCart.forEach(function(e){e.checked=!1}),$scope.mealInfoList.forEach(function(t){t.checked=!1,t.selectedCount=0,t.totalPrice=0,t.itemList=[],$scope.shoppingCart.forEach(function(e){e.mealId==t.id&&(t.selectedCount+=e.count,t.totalPrice+=e.count*(100*e.promotion)/100,t.itemList.push(e))}),1==t.id?0!=t.selectedCount&&(t.checked=!0,t.itemList.forEach(function(e){e.checked=!0})):0==t.selectedCount||e||(t.checked=!0,t.itemList.forEach(function(e){e.checked=!0}),e=!0)})};var wxInit={deferred:$q.defer()};wxInit.promise=wxInit.deferred.promise,$scope.shareToPromiseList.push(wxInit.promise),$http.post("/index/getWeChatJsSign?url="+$scope.wxCheckSignHost,{url:$scope.wxCheckSignHost}).success(function(e,t,o,r){0==e.statusCode&&(wx.config(angular.fromJson(e.data)),wx.ready(function(){wxInit.deferred.resolve("loaded!")}))})}]).factory("ltTimeSet",["$filter",function(e){var t=!0;return{getTimeFn:function(o,r){var s=[],n=new Date,i=new Date(o[0].date.replace(/\./g,"/")+" 18:30");t=n>i?!1:!0;for(var a=0;a<o.length;a++){var c={};c.valueName=o[a].chineseDate+"("+o[a].sequence+")",c.value=o[a].date,c.list=[],s.push(c)}for(var d=0;d<r.length;d++){var p=r[d].valueName.split("-")[0],u=new Date(e("date")(n,"yyyy/MM/dd ")+p),l=p.split(":");r[d].index=Number(l.join("")),u>n&&s[0].list.push(r[d]),s[1].list.push(r[d])}return t&&0!=s[0].list.length||s.shift(),s}}}]).filter("filterModel",[function(){return function(e,t){var o=e||"",r=o.split(",");return"orderNumber"==t?r[0]:"address"==t?r[1]:void 0}}]).service("order",["$scope","$state",function(e,t){var o=this;o.mealInfoId=0,o.takeType=1}]);angular.module("xsyh").controller("activityCtrl",["$scope","$http","$stateParams",function(e,t,o){e.$on("initActivity",function(t){e.initActivity()}),e.initActivity=function(){o.activityId?t.post("/activities/findActivity",{activityId:o.activityId}).success(function(t,o,r,s){0==t.statusCode&&(e.$parent.activityInfo.frameList=t.data.content)}):e.showComnPopup({message:"活动ID不存在",type:"alert",alert:function(){e.go("home")}})},e.$parent.totalCommodityList.length>0&&e.initActivity(),e.changeView=function(t,o){1==t.frame&&(1==o.moduleType&&o.value?location.href=o.value:2==o.moduleType&&o.value&&e.go("commodity-detail",{commodityId:o.value}))}}]),angular.module("xsyh").controller("addressCtrl",["$scope","$http","$ionicModal","$stateParams",function(e,t,o,r){e.from=r.from,e.renderAddressView=function(){t.post("/address/getAddressList",{test:1}).success(function(o,r,s,n){0==o.statusCode&&(e.addressList=o.data,"pay"==e.from&&t.post("/address/getAddressListByStore",{storeId:e.$parent.currStore.storeId}).success(function(t,o,r,s){0==t.statusCode&&t.data.forEach(function(t){e.addressList.forEach(function(e){t.addressId==e.addressId&&(e.isAvailable=!0)})})}))})},o.fromTemplateUrl("userAddress.html",{scope:e,animation:"slide-in-left"}).then(function(t){e.userAddressModal=t}),e.closeUserAddressModal=function(){e.userAddressModal.hide()},e.openUserAddressModal=function(o){t.post("/address/getStoreDistributionAddressList",{storeId:e.$parent.currStore.storeId}).success(function(t,r,s,n){if(0==t.statusCode){if(e.storeDistributionAddressList=t.data,0==e.storeDistributionAddressList.length)return void e.showComnPopup({message:"没有可用的商圈地址!",type:"toast"});o?e.currUserAddress=angular.copy(o):e.currUserAddress={isDefault:2,status:10,storeAddressId:e.storeDistributionAddressList[0].addressId,sex:1},e.userAddressModal.show()}})},e.saveUserAddress=function(){if(!e.currUserAddress.consignee||0==e.currUserAddress.consignee.length)return void e.showComnPopup({message:"请填写收货人姓名!",type:"toast"});if(!e.currUserAddress.sex)return void e.showComnPopup({message:"请选择性别!",type:"toast"});if(!e.currUserAddress.storeAddressId)return void e.showComnPopup({message:"请选择收货地址!",type:"toast"});if(!e.currUserAddress.address||0==e.currUserAddress.address.length)return void e.showComnPopup({message:"请输入门牌号!",type:"toast"});if(!/^1[\d]{10}$/.test(e.currUserAddress.phone))return void e.showComnPopup({message:"请输入正确的手机号!",type:"toast"});var o=e.currUserAddress;e.storeDistributionAddressList.forEach(function(t){t.addressId==e.currUserAddress.storeAddressId&&(o.area=t.area)}),t.post("/address/saveAddress",o).success(function(t,o,r,s){0==t.statusCode&&e.renderAddressView()}),e.userAddressModal.hide()},e.setUserDefaultAddress=function(o){t.post("/address/saveAddress",o).success(function(t,o,r,s){0==t.statusCode&&e.renderAddressView()})},e.useUserAddress=function(t){e.from&&(t.isAvailable?(e.$parent.currUserAddress=t,e.userAddressModal.hide(),history.back()):e.showComnPopup({message:"当前地址不可用,请重新选择!",type:"alert"}))},e.deleteAddress=function(o){var r={title:"是否确认删除当前地址?",type:"confirm"};r.confirm=function(){o.status=20,t.post("/address/saveAddress",o).success(function(t,o,r,s){0==t.statusCode&&e.renderAddressView()})},e.showComnPopup(r)},e.renderAddressView()}]),angular.module("xsyh").controller("detailCtrl",["$scope","$http","$stateParams",function(e,t,o){e.initCommodityDetail=function(){o.commodityId&&(e.currItem=e.$parent.totalCommodityList.filter(function(e){return e.commodityId==o.commodityId})[0])},e.$parent.totalCommodityList.length>0?e.initCommodityDetail():e.currItem=null,e.$on("initCommodityDetail",function(t){e.initCommodityDetail()})}]),angular.module("xsyh").controller("commodityGroupCtrl",["$scope","$http","$stateParams","$interval","$ionicBackdrop","$q",function(e,t,o,r,s,n){e.$on("$ionicView.leave",function(){e.$parent.activityInfo.showShareMask&&(e.$parent.activityInfo.showShareMask=!1),e.timer&&r.cancel(e.timer)});var i={deferred:n.defer()};i.promise=i.deferred.promise,e.$parent.shareToPromiseList.push(i.promise),n.all(e.$parent.shareToPromiseList).then(function(t){e.shareTo()},function(e){alert("Fail: "+e)}),e.initCommodityGroup=function(){location.hash.indexOf("shareMemberInfoId")>=0&&(e.$parent.order.shareMemberInfoId=location.hash.replace(/.*[\?|\&]shareMemberInfoId\=([^\&]*)\&?.*/,"$1")),o.activityId?(e.$parent.order.shareActivityId=o.activityId,t.post("/activities/findActivity",{activityId:o.activityId}).success(function(t,o,s,n){if(0==t.statusCode){e.$parent.activityInfo=t.data;var a=e.$parent.activityInfo.commodityId;e.$parent.activityInfo.commodity=e.$parent.totalCommodityList.filter(function(e){return e.commodityId==a})[0],e.$parent.activityInfo.commodity||e.showComnPopup({message:"团购商品暂未上架",type:"alert",alert:function(){e.go("home")}}),e.$parent.activityInfo.storeInfo=e.$parent.storeList.filter(function(t){return t.storeId==e.$parent.currStore.storeId})[0],e.cd=Math.floor((e.$parent.activityInfo.endtime-(new Date).getTime())/1e3),e.CD=function(){var t=e.cd;e.$parent.activityInfo.CDHours=Math.floor(t/3600),e.$parent.activityInfo.CDMinute=Math.floor((t-3600*e.$parent.activityInfo.CDHours)/60),e.$parent.activityInfo.CDSecond=Math.ceil(t-3600*e.$parent.activityInfo.CDHours-60*e.$parent.activityInfo.CDMinute),60==e.$parent.activityInfo.CDSecond&&(e.$parent.activityInfo.CDMinute++,e.$parent.activityInfo.CDSecond=0),e.$parent.activityInfo.CDHours<10&&(e.$parent.activityInfo.CDHours="0"+e.$parent.activityInfo.CDHours),e.$parent.activityInfo.CDMinute<10&&(e.$parent.activityInfo.CDMinute="0"+e.$parent.activityInfo.CDMinute),e.$parent.activityInfo.CDSecond<10&&(e.$parent.activityInfo.CDSecond="0"+e.$parent.activityInfo.CDSecond),e.cd--},e.cd<=0?(e.$parent.activityInfo.CDHours="00",e.$parent.activityInfo.CDMinute="00",e.$parent.activityInfo.CDSecond="00",e.showComnPopup({message:"团购活动已结束",type:"alert",alert:function(){e.go("home")}})):e.$parent.activityInfo.starttime<=(new Date).getTime()?(e.timer=r(function(){e.CD()},1e3),e.CD(),i.deferred.resolve("loaded!")):e.showComnPopup({message:"团购活动还未开始!",type:"alert",alert:function(){e.go("home")}})}})):e.showComnPopup({message:"活动ID不存在!",type:"alert",alert:function(){e.go("home")}})},e.$parent.totalCommodityList.length>0&&e.initCommodityGroup(),e.$on("initCommodityGroup",function(t){e.initCommodityGroup()}),e.shareTo=function(t){var o=location.origin+"/index/indexpage?type=70&shareMemberInfoId="+e.$parent.userInfo.memberInfoId+"&storeId="+e.$parent.activityInfo.storeInfo.storeId+"&activityId="+e.$parent.activityInfo.activityId,r=e.$parent.activityInfo.commodity.promotion+"元|"+e.$parent.activityInfo.name,s=e.imgRoot+e.$parent.activityInfo.commodity.commodityBigImg;t?e.$parent.activityInfo.showShareMask=!0:(wx.onMenuShareAppMessage({title:r,link:o,imgUrl:s,success:function(){},cancel:function(){}}),wx.onMenuShareTimeline({title:r,link:o,imgUrl:s,success:function(){},cancel:function(){}}))}}]),angular.module("xsyh").controller("couponsCtrl",["$scope","$http","$stateParams","$filter",function(e,t,o,r){e.from=o.from,e.showHistoryFlg=!1,t.post("/coupons/getCouponsList",{test:1}).success(function(t,o,s,n){if(0==t.statusCode){var i=(new Date).getTime();"pay"==e.from?(e.couponsList=t.data.filter(function(t){return t.stores&&(t.stores=","+t.stores+","),t.commodities&&(t.commodities=","+t.commodities+","),!t.stores||t.stores.indexOf(","+e.$parent.currStore.storeId+",")>=0&&t.starttime<=i&&i<=t.endtime?e.$parent.shoppingCart.filter(function(e){return e.checked}).some(function(e){return!t.commodities||t.commodities.indexOf(","+e.commodityId+",")>=0}):!1}),e.couponsList.forEach(function(t){t.displayTime=r("date")(t.starttime,"yyyy-MM-dd")+"~"+r("date")(t.endtime,"yyyy-MM-dd"),e.$parent.currCoupons&&e.$parent.currCoupons.couponsId==t.couponsId&&(t.checked=!0)})):"my"==e.from&&(e.couponsList=t.data.forEach(function(e){i>e.endtime&&1==e.status&&(e.status=4)}),e.couponsList=t.data),e.couponsList.forEach(function(e){e.displayTime=r("date")(e.starttime,"yyyy-MM-dd")+"~"+r("date")(e.endtime,"yyyy-MM-dd")})}}),e.useCoupons=function(t){"pay"==e.from&&(t.checked=!0,e.$parent.currCoupons=t,e.discountPrice=e.$parent.shoppingCartTotalPrice,e.$parent.currBusiness&&e.$parent.currBusiness.addressId&&(e.discountPrice=e.discountPrice*e.$parent.TakeType3.discount),e.discountPrice=e.discountPrice-e.$parent.currCoupons.price,e.$parent.order.price=e.discountPrice>=0?r("number")(e.discountPrice,2):0,e.go("pay",{from:"coupons"}))},e.noUseCoupons=function(){"pay"==e.from&&(e.$parent.currCoupons=null,e.discountPrice=e.$parent.shoppingCartTotalPrice,e.$parent.currBusiness&&e.$parent.currBusiness.addressId&&(e.discountPrice=e.discountPrice*e.$parent.TakeType3.discount),e.$parent.order.price=e.discountPrice>=0?r("number")(e.discountPrice,2):0),e.go("pay",{from:"coupons"})},e.showHistory=function(){e.showHistoryFlg=e.showHistoryFlg?!e.showHistoryFlg:!0}}]),angular.module("xsyh").controller("groupInfoCtrl",["$scope","$http","$stateParams",function(e,t,o){t.post("/order/findGroupBuyPeople",{groupMealId:o.groupMealId}).success(function(t){0==t.statusCode?e.groupMealList=t.data:alert(t.statusMessage)})}]),angular.module("xsyh").controller("homeCtrl",["$scope","$http","$ionicHistory","$q","$timeout","$ionicSlideBoxDelegate",function(e,t,o,r,s,n){e.initHomePage=function(){t.post("/index/getHomePage",{storeId:e.currStore.storeId}).success(function(t,o,r,s){0==t.statusCode&&(e.frameList=t.data.modelInfoList.content,e.themeList=t.data.themeList)})},e.$on("initHomePage",function(t){e.initHomePage()}),e.changeView=function(t,o,r){1==t.frame?1==o.type?1==r.type&&r.value?r.value.indexOf("?")>0?location.href=r.value+"&storeId="+e.currStore.storeId:location.href=r.value+"?storeId="+e.currStore.storeId:2==r.type?location.href="#/commodityDetail?commodityId="+r.value+"&storeId="+e.currStore.storeId:3==r.type?location.href="#/order?orderType=nopay":4==r.type||(5==r.type?location.href="#/coupons?from=my":6==r.type||7==r.type&&(location.href="#/coupons?from=my")):2==o.type&&o.elements[0].value?o.elements[0].value.indexOf("?")>0?location.href=o.elements[0].value+"&storeId="+e.currStore.storeId:location.href=o.elements[0].value+"?storeId="+e.currStore.storeId:6==o.type&&(1==o.elements[0].type?o.elements[0].value.indexOf("?")>0?location.href=o.elements[0].value+"&storeId="+e.currStore.storeId:location.href=o.elements[0].value+"?storeId="+e.currStore.storeId:5==o.elements[0].type?location.href="#/coupons?from=my":7==o.elements[0].type&&(location.href="#/order?orderType=wait")):2==t.frame?3==o.type?location.href="#/commodityDetail?commodityId="+o.elements[0].value+"&storeId="+e.currStore.storeId:2==o.type&&o.elements[0].value&&(o.elements[0].value.indexOf("?")>0?location.href=o.elements[0].value+"&storeId="+e.currStore.storeId:location.href=o.elements[0].value+"?storeId="+e.currStore.storeId):3==t.frame||(4==t.frame?4==o.type?e.themeList.forEach(function(t,r){t.id==o.elements[0].value&&(location.href="#/list?from=custom_"+r+"&storeId="+e.currStore.storeId)}):2==o.type&&o.elements[0].value&&(o.elements[0].value.indexOf("?")>0?location.href=o.elements[0].value+"&storeId="+e.currStore.storeId:location.href=o.elements[0].value+"?storeId="+e.currStore.storeId):5==t.frame&&(3==o.type?location.href="#/commodityDetail?commodityId="+o.elements[0].value+"&storeId="+e.currStore.storeId:2==o.type&&o.elements[0].value&&(location.href=o.elements[0].value)))},e.updateSlideBox=function(){n.$getByHandle("banner").update()},e.$parent.currFooterMenu=0,e.currStore&&e.currStore.storeId?e.initHomePage():!e.currStore&&o.backView()&&e.$parent.openAddressModal(),e.getImgBlob=function(e){t.get(e.imageUrl,{responseType:"blob"}).success(function(t){var o=new Blob([t],{type:"image/png"});e.imageUrl=webkitURL.createObjectURL(o),e.deferred.resolve("loaded!")}).error(function(){e.imageUrl="",e.deferred.resolve("loaded!")})}}]),angular.module("xsyh").controller("listCtrl",["$scope","$ionicScrollDelegate","$timeout","$http","$stateParams",function(e,t,o,r,s){e.from=s.from,e.$on("$ionicView.enter",function(){e.$parent.calcCurrViewShoppingCartNum()}),e.initItemList=function(){e.$parent.currIndex=0,e.totalItemList=[];var t=document.getElementsByTagName("ion-content")[0].offsetHeight;e.from&&-1!=e.from.indexOf("custom")&&r.post("/goods/getListCommodity",{storeId:e.$parent.currStore.storeId}).success(function(o,r,s,n){0==o.statusCode&&(e.$parent.categoryList=o.data.themeList,e.$parent.categoryList.forEach(function(r,s,n){r.itemList=o.data.commodityList[s];var i=r.itemList;r.itemList=[],i.forEach(function(t,o,s){var n=e.$parent.totalCommodityList.filter(function(e){return t&&e.commodityId==t.commodityId});n.length>0&&r.itemList.push(n[0])}),r.height=r.itemList.length*e.itemHeight+e.itemTabHeight,r.itemList.unshift({name:r.name}),0==s?(r.scrollTo=0,e.class0=r.height):s==n.length-1?(t>r.height&&(e.fixedCount=Math.ceil((t-r.height)/e.itemHeight),r.itemList.push({empty:!0,height:e.fixedCount*e.itemHeight}),r.height=(r.itemList.length-1+e.fixedCount)*e.itemHeight+e.itemTabHeight),r.scrollTo=e["class"+(s-1)],e["class"+s]=e["class"+(s-1)]+r.height):(r.scrollTo=e["class"+(s-1)],e["class"+s]=e["class"+(s-1)]+r.height),Array.prototype.push.apply(e.totalItemList,r.itemList),e.$parent.watchCategoryList(s)}),e.scrollTo(e.$parent.categoryList[+e.from.substring(7)],+e.from.substring(7)),e.mainScroll.resize())})},e.$on("initItemList",function(t){e.initItemList()}),e.$parent.shoppingCart.reverse(),e.mainScroll=t.$getByHandle("mainScroll"),e.swipe=function(){o(function(){e.top=e.mainScroll.getScrollPosition().top,e.$parent.currIndex=0,e.$parent.categoryList.forEach(function(t,o,r){e.top>=t.scrollTo&&(e.$parent.currIndex=o)})},0)},e.scrollTo=function(t,o){o!=e.$parent.currIndex&&e.mainScroll.scrollTo(null,t.scrollTo,!1),e.$parent.currIndex=o},e.currStore&&e.currStore.storeId&&e.initItemList()}]),angular.module("xsyh").controller("myCtrl",["$scope","$http","$ionicModal",function(e,t,o){e.$parent.currFooterMenu=3}]),angular.module("xsyh").controller("orderCtrl",["$scope","$http","$stateParams","$ionicPopup","$ionicScrollDelegate","$ionicLoading",function(e,t,o,r,s,n){e.orderType=o.orderType||"nopay",e.config={distributionTime:{},store:{}},e.totalOrderList={nopay:{orderList:[],pageIndex:0,count:0,orderStates:10,url:"order/getMyUnpaidOrder"},wait:{orderList:[],pageIndex:0,orderStates:30,url:"order/getMyPickOrder",count:0},over:{orderList:[],pageIndex:0,count:0,orderStates:40,url:"order/getMyFinishedOrder"},cancel:{orderList:[],pageIndex:0,count:0,orderStates:60,url:"order/getMyCancelOrder"}},e.Fn={},e.Fn.getData=function(o){n.show({hideOnStateChange:!0,template:"数据加载中...",noBackdrop:!1}),t.post(e.totalOrderList[o].url,{pageIndex:0,pageSize:0}).success(function(t){n.hide(),0==t.statusCode?(e.orderType=o,e.totalOrderList[o].orderList=t.data,e.totalOrderList[o].orderList.forEach(function(t){e.config.store[t.storeId]&&e.config.store[t.storeId].name&&(t.storeName=e.config.store[t.storeId].name),e.config.distributionTime[t.distributionTime]&&e.config.distributionTime[t.distributionTime].valueName&&(t.displayTime=t.distributionDate+" "+e.config.distributionTime[t.distributionTime].valueName),t.commodityCount=0,t.commodityList.forEach(function(e){t.commodityCount+=e.totalNum})}),e.mainScroll.scrollTop()):alert(t.statusMessage)})},e.Fn.pay=function(o){e.paying||(e.showComnPopup({message:"支付中...",type:"toast"}),e.paying=!0,t.post("order/payOrder",{orderId:o.orderId}).success(function(r,s,n,i){if(0==r.statusCode){var i=angular.fromJson(r.data);i.success=function(r){
t.get("/order/getUUID?prePay_Id="+i["package"].substring(10)).success(function(t,r,s,n){0==t.statusCode&&(e.paying=!1,e.showComnPopup({message:"订单已支付",type:"toast"}),e.totalOrderList.nopay.orderList.splice(e.totalOrderList.nopay.orderList.indexOf(o),1),e.go("order-detail",{orderInfo:t.data,orderId:t.data.orderId,from:"order"}))})},i.cancel=function(t){e.showComnPopup({message:"支付已取消",type:"toast"}),e.paying=!1},wx.chooseWXPay(i)}else alert(r.statusMessage)}))},e.Fn.cancelOrder=function(o){var r={title:"是否确认取消订单?",type:"confirm"};r.confirm=function(){t.post("/order/cancel",{orderId:o.orderId}).success(function(t){0==t.statusCode&&(e.showComnPopup({message:"订单取消成功",type:"toast"}),e.totalOrderList.nopay.orderList.splice(e.totalOrderList.nopay.orderList.indexOf(o),1))})},e.showComnPopup(r)},e.Fn.stateChange=function(t){e.Fn.getData(t)},e.initOrder=function(){e.$parent.storeList.forEach(function(t){e.config.store[t.storeId]=t}),e.$parent.timeList.forEach(function(t){e.config.distributionTime[t.value]=t}),e.mainScroll=s.$getByHandle("mainScroll"),e.Fn.stateChange(e.orderType)},e.$on("initOrder",function(t){e.initOrder()}),e.$parent.storeList&&e.$parent.storeList.length>0&&e.initOrder()}]),angular.module("xsyh").controller("orderInfoCtrl",["$scope","$http","$stateParams","$filter",function(e,t,o,r){e.config={distributionTime:{},store:{}},e.initOrderInfo=function(){e.$parent.storeList.forEach(function(t){e.config.store[t.storeId]=t}),e.$parent.timeList.forEach(function(t){e.config.distributionTime[t.value]=t}),o.orderInfo&&(e.orderInfo=o.orderInfo,e.orderInfo.distributionTime&&(e.orderInfo.displayTime=r("date")(e.orderInfo.distributionDate,"yyyy-MM-dd")+" "+e.config.distributionTime[e.orderInfo.distributionTime].valueName),e.orderInfo.storeId&&(e.orderInfo.storeName=e.config.store[e.orderInfo.storeId].name)),!o.orderInfo&&o.orderId&&t.post("order/findByOrderId",{orderId:o.orderId}).success(function(t,o,s,n){0==t.statusCode&&(e.orderInfo=t.data,e.orderInfo.distributionTime&&(e.orderInfo.displayTime=r("date")(e.orderInfo.distributionDate,"yyyy-MM-dd")+" "+e.config.distributionTime[e.orderInfo.distributionTime].valueName),e.orderInfo.storeId&&(e.orderInfo.storeName=e.config.store[e.orderInfo.storeId].name))})},e.$parent.storeList&&e.$parent.storeList.length>0&&e.initOrderInfo(),e.$on("initOrderInfo",function(t){e.initOrderInfo()}),e.pay=function(r){e.paying||(e.paying=!0,"posScan"==o.from?t.post("order/payOrderOnly",{storeId:r.storeId,orderNumber:r.orderNumber}).success(function(o,s,n,i){if(0==o.statusCode){var i=angular.fromJson(o.data.payConfig);i.success=function(o){t.get("/order/paySuccessScan?orderCode="+r.orderCode).success(function(t,o,r,s){0==t.statusCode&&(e.paying=!1,e.showComnPopup({message:"订单已支付",type:"alert"}),e.go("home"))})},i.cancel=function(t){e.showComnPopup({message:"支付已取消",type:"toast"}),e.paying=!1},wx.chooseWXPay(i)}else alert(o.statusMessage),e.paying=!1}):t.post("order/payOrder",{orderId:r.orderId}).success(function(o,r,s,n){if(0==o.statusCode){var n=angular.fromJson(o.data);n.success=function(o){t.get("/order/getUUID?prePay_Id="+n["package"].substring(10)).success(function(t,o,r,s){0==t.statusCode&&(e.paying=!1,e.showComnPopup({message:"订单已支付",type:"toast"}),e.go("order",{orderType:"nopay"}))})},n.cancel=function(t){e.showComnPopup({message:"支付已取消",type:"toast"}),e.paying=!1},wx.chooseWXPay(n)}else alert(o.statusMessage),e.paying=!1}))}}]),angular.module("xsyh").controller("payCtrl",["$scope","$http","$filter","$timeout","$ionicModal","$ionicBackdrop","ltTimeSet","$ionicPopup","$stateParams","$ionicHistory",function(e,t,o,r,s,n,i,a,c,d){e.$on("$ionicView.leave",function(t){e.businessPopup&&e.businessPopup.close&&e.businessPopup.close(),e.businessAddressModal&&e.businessAddressModal.isShown()&&e.businessAddressModal.remove(),e.couponsModal&&e.couponsModal.isShown()&&e.couponsModal.remove(),e.$parent.showMutilScroll&&e.$parent.closeMutilScrollPopup()}),e.$on("$ionicView.enter",function(){return 0==e.$parent.shoppingCart.length?void(location.href="#/home"):(e.from=c.from,e.$parent.currCoupons={},e.$parent.TakeType3={},e.distributionTime={},e.$parent.timeList.forEach(function(t){e.distributionTime[t.value]=t}),e.$parent.order.orderInfoVoList=[],e.$parent.shoppingCart.forEach(function(t){if(t.checked){var o={};o.commodityId=t.commodityId,o.commodityNum=t.count,e.$parent.order.orderInfoVoList.push(o)}}),e.calcOrderPrice=function(){e.discountPrice=e.$parent.shoppingCartTotalPrice,e.$parent.currBusiness&&e.$parent.currBusiness.addressId&&3==e.$parent.order.takeType&&(e.discountPrice=e.discountPrice*e.$parent.TakeType3.discount),e.$parent.currCoupons&&e.$parent.currCoupons.couponsId&&(e.discountPrice=e.discountPrice-e.$parent.currCoupons.price),2==e.$parent.order.takeType&&(e.discountPrice<0&&(e.discountPrice=0),e.discountPrice+=e.$parent.currStore.distributePrice);var o=angular.copy(e.$parent.order);if(2==o.takeType){if(!e.$parent.currUserAddress||!e.$parent.currUserAddress.addressId)return e.discountList=[],void(e.$parent.order.price=e.discountPrice>=0?e.discountPrice:0);if(o.addressId=e.$parent.currUserAddress.addressId,o.price<e.$parent.currStore.distributeCost)return e.discountList=[],void(e.$parent.order.price=e.discountPrice>=0?e.discountPrice:0)}else if(3==o.takeType){if(!e.$parent.currBusiness||!e.$parent.currBusiness.addressId)return e.discountList=[],void(e.$parent.order.price=e.discountPrice>=0?e.discountPrice:0);o.businessAddressId=e.$parent.currBusiness.addressId,o.businessCode=e.$parent.currBusiness.businessCode,o.mealInfoId=e.mealInfoId}return e.$parent.currCoupons&&(o.couponsId=e.$parent.currCoupons.couponsId),o.cellPhone&&/^1[\d]{10}$/.test(o.cellPhone)?(o.storeId=e.$parent.currStore.storeId,void t.post("/order/calculateOrder",o).success(function(t,o,r,s){0==t.statusCode?(e.discountList=t.data.list,e.$parent.order.price=t.data.total):(e.discountList=[],e.$parent.order.price=e.discountPrice>=0?e.discountPrice:0)})):(e.discountList=[],void(e.$parent.order.price=e.discountPrice>=0?e.discountPrice:0))},e.changeTakeType=function(){var t,o;e.$parent.mealInfoList.forEach(function(t){t.itemList.length>0&&t.itemList.some(function(e){return e.checked})&&(o=angular.copy(t.mealTimeItemList),e.$parent.order.mealInfoId=t.id,e.mealInfoId=t.id)}),3!=e.$parent.order.takeType?(t=angular.copy(e.$parent.dateList),o.forEach(function(e){e.valueName=e.value,e.value=e.key}),e.$parent.lttimedate=i.getTimeFn(t,o),e.$parent.currStore.defaultAddress&&!e.$parent.currUserAddress&&(e.$parent.currUserAddress=e.$parent.currStore.defaultAddress)):(e.$parent.currBusiness=null,e.$parent.lttimedate=[]),e.$parent.lttimedate.length>0?(e.$parent.exchangeDate=e.$parent.lttimedate[0].valueName,e.$parent.order.distributionDate=e.$parent.lttimedate[0].value,e.$parent.exchangeTime=e.$parent.lttimedate[0].list[0].valueName,e.$parent.order.distributionTime=e.$parent.lttimedate[0].list[0].value):(e.$parent.exchangeDate="",e.$parent.order.distributionDate="",e.$parent.exchangeTime="",e.$parent.order.distributionTime=""),e.calcOrderPrice()},e.changeTakeType(),e.submitOrder=function(){if(!(e.$parent.shoppingCartTotalPrice<0||e.paying)){var o=angular.copy(e.$parent.order);if(2==o.takeType){if(!e.$parent.currUserAddress||!e.$parent.currUserAddress.addressId)return void e.showComnPopup({message:"请选择收货地址!",type:"toast"});if(o.addressId=e.$parent.currUserAddress.addressId,o.price<e.$parent.currStore.distributeCost)return void e.showComnPopup({message:"当前门店满"+e.$parent.currStore.distributeCost+"元配送!",type:"toast"})}else if(3==o.takeType){if(!e.$parent.currBusiness||!e.$parent.currBusiness.addressId)return void e.showComnPopup({message:"请选择参团地址!",type:"toast"});o.businessAddressId=e.$parent.currBusiness.addressId,o.businessCode=e.$parent.currBusiness.businessCode,o.mealInfoId=e.mealInfoId}if(e.$parent.currCoupons&&(o.couponsId=e.$parent.currCoupons.couponsId),!o.cellPhone||!/^1[\d]{10}$/.test(o.cellPhone))return void e.showComnPopup({message:"请输入正确的手机号码!",type:"toast"});o.storeId=e.$parent.currStore.storeId,e.showComnPopup({message:"支付中...",type:"toast"}),e.paying=!0,t.post("/order/submitOrder",o).success(function(s,n,i,a){if(0==s.statusCode){var a=angular.fromJson(s.data.payConfig);a.success=function(t){var o={type:"prePay_Id",data:s.data.prePay_Id};e.getOrderInfo(o)},a.fail=function(n){r(function(){e.showComnPopup({message:"网络繁忙,请重试!",type:"alert"}),e.paying=!1,t.post("/index/requestError",{errorUrl:location.origin+"/order/submitOrder",errorRequest:angular.toJson(o),errorResponse:s.data.payConfig||angular.toJson(a),errorMessage:angular.toJson(n)})},0)},a.cancel=function(o){r(function(){e.paying=!1;var o={};s.data.orderId&&s.data.orderId.length>0&&(o.orderId=s.data.orderId),s.data.prePay_Id&&s.data.prePay_Id.length>0&&(o.prePay_Id=s.data.prePay_Id),t.post("/order/cancel",o)},0)},wx.chooseWXPay(a)}else if(1==s.statusCode){var c={type:"orderCode",data:s.data.orderCode};e.getOrderInfo(c)}else e.showComnPopup({message:s.statusMessage,type:"alert"}),e.paying=!1}).error(function(t,o,r,s){0==o?(payError++,payError<=3?e.submitOrder():e.showComnPopup({message:"当前网络异常,请重试!",type:"alert",alert:function(){e.paying=!1,payError=0}})):(e.showComnPopup({message:"errorStatus:"+o+" errorData:"+angular.toJson(t),type:"alert"}),e.paying=!1)})}},e.getOrderInfo=function(o){var r="/order/getUUID?"+o.type+"="+o.data;t.get(r).success(function(t,o,r,s){0==t.statusCode&&(e.paying=!1,e.$parent.currCoupons={},e.$parent.currBusiness={},e.$parent.currAddress={},e.go("order-detail",{orderInfo:t.data,orderId:t.data.orderId,from:"pay"}))}).error(function(t,r,s,n){e.getOrderInfo(o)})},e.timePickerShowFn=function(){return 3!=e.$parent.order.takeType||e.$parent.currBusiness?void r(function(){var t={dataSource:e.$parent.lttimedate,activeIndexList:[e.$parent.order.distributionDate,e.$parent.order.distributionTime]};t.success=function(t){if(e.$parent.exchangeDate=t[0].valueName,e.$parent.order.distributionDate=t[0].value,e.$parent.exchangeTime=t[1].valueName,e.$parent.order.distributionTime=t[1].value,1==e.$parent.order.mealInfoId)for(var o in e.$parent.TakeType3.distributionTime)e.$parent.TakeType3.distributionTime[o]==e.$parent.order.distributionTime&&(e.mealInfoId=o)},e.showMutilScrollPopup(t)},50):void e.showComnPopup({message:"请选择参团地址!",type:"toast"})},e.showBusinessPopup=function(){e.tmpCode={},e.businessPopup=a.show({template:"<input placeholder='请输入合作企业代码' type='tel' ng-model='tmpCode.businessCode'autofocus><i class='btn-close' ng-click='businessPopup.close()'></i>",scope:e,cssClass:"businessPopup",buttons:[{text:"<b>确定</b>",onTap:function(t){return e.tmpCode.businessCode}}]}),e.businessPopup.then(function(o){o&&(angular.isNumber(Number(o))?t.post("/order/checkBusinessCode",{storeId:e.currStore.storeId,businessCode:o}).success(function(t,o,r,s){0==t.statusCode?t.data.enterpriseAddressList.length>0&&(e.$parent.TakeType3.distributionTime=t.data.distributionTime,e.$parent.TakeType3.discount=t.data.discount/100,1==t.data.enterpriseAddressList.length?e.useBusinessAddressModal(t.data.enterpriseAddressList[0]):(e.businessAddressList=t.data.enterpriseAddressList,e.businessAddressModal.show())):e.showComnPopup({message:t.statusMessage,type:"alert"})}):e.showComnPopup({message:"请输入6位企业合作代码!",type:"toast"}))})},s.fromTemplateUrl("businessAddress.html",{scope:e,animation:"slide-in-left"}).then(function(t){e.businessAddressModal=t}),e.useBusinessAddressModal=function(t){e.$parent.currBusiness=t;var o,r;if(o=angular.copy(e.$parent.dateList),o.forEach(function(e){e.valueName=e.chineseDate+"("+e.sequence+")",e.value=e.date}),1==e.$parent.order.mealInfoId)r=[],e.$parent.TakeType3.distributionTime[2]&&r.push(e.distributionTime[e.$parent.TakeType3.distributionTime[2]]),e.$parent.TakeType3.distributionTime[3]&&r.push(e.distributionTime[e.$parent.TakeType3.distributionTime[3]]),e.$parent.TakeType3.distributionTime[4]&&r.push(e.distributionTime[e.$parent.TakeType3.distributionTime[4]]);else{if(!e.$parent.TakeType3.distributionTime[e.$parent.order.mealInfoId])return void e.showComnPopup({message:"当前餐别不支持配送!",type:"toast"});r=[e.distributionTime[e.$parent.TakeType3.distributionTime[e.$parent.order.mealInfoId]]]}if(e.$parent.lttimedate=i.getTimeFn(o,r),e.$parent.exchangeDate=e.$parent.lttimedate[0].valueName,e.$parent.order.distributionDate=e.$parent.lttimedate[0].value,e.$parent.exchangeTime=e.$parent.lttimedate[0].list[0].valueName,e.$parent.order.distributionTime=e.$parent.lttimedate[0].list[0].value,1==e.$parent.order.mealInfoId)for(var s in e.$parent.TakeType3.distributionTime)e.$parent.TakeType3.distributionTime[s]==e.$parent.order.distributionTime&&(e.mealInfoId=s);e.calcOrderPrice(),e.businessAddressModal.isShown()&&e.businessAddressModal.hide()},e.closeBusinessAddressModal=function(){e.businessAddressModal.hide()},s.fromTemplateUrl("coupons.html",{scope:e,animation:"slide-in-left"}).then(function(t){e.couponsModal=t}),e.closeCouponsModal=function(){e.couponsModal.hide()},e.openCouponsModal=function(){t.post("/coupons/getCouponsList",{test:1}).success(function(t,r,s,n){if(0==t.statusCode){var i=(new Date).getTime();e.couponsList=t.data.filter(function(e){return i<=e.endtime&&1==e.status}),e.couponsList.forEach(function(t){t.displayTime=o("date")(t.starttime,"yyyy-MM-dd")+"~"+o("date")(t.endtime,"yyyy-MM-dd"),e.$parent.currCoupons&&e.$parent.currCoupons.couponsId==t.couponsId&&(t.checked=!0)}),e.couponsModal.show()}})},e.useCoupons=function(t){var o=(new Date).getTime();t.stores&&0!=t.stores.indexOf(",")&&(t.stores=","+t.stores+","),t.commodities&&0!=t.commodities.indexOf(",")&&(t.commodities=","+t.commodities+",");var r="";return t.starttime>o&&(r="当前优惠券未到使用期!"),0==r.length&&o>t.endtime&&(r="当前优惠券已过期!"),0==r.length&&1!=t.status&&(r="当前优惠券状态异常!"),0==r.length&&t.stores&&t.stores.indexOf(","+e.$parent.currStore.storeId+",")<0&&(r="当前优惠券可用门店不包含当前门店!"),0!=r.length||e.$parent.shoppingCart.filter(function(e){return e.checked}).some(function(e){return!t.commodities||t.commodities.indexOf(","+e.commodityId+",")>=0})||(r="当前优惠券可用商品不支持当前所选商品!!"),e.$parent.shoppingCartTotalPrice<t.costPrice&&(r="当前优惠券必须满"+t.costPrice+"元才可使用!"),r.length>0?void e.showComnPopup({message:r,type:"toast"}):(t.checked=!0,e.$parent.currCoupons=t,e.calcOrderPrice(),void e.closeCouponsModal())},void(e.noUseCoupons=function(){e.$parent.currCoupons=null,e.calcOrderPrice(),e.closeCouponsModal()}))})}]),angular.module("xsyh").controller("posScanCtrl",["$scope","$http","$stateParams",function(e,t,o){e.$on("initPosScan",function(t){e.initPosScan()}),e.initPosScan=function(){e.$parent.currStore=e.$parent.storeList.filter(function(e,t,r){return e.storeId==o.storeId})[0],o.orderNumber&&(e.orderNumber=o.orderNumber,e.getOrderInfoByOrderNumber())},e.getOrderInfoByOrderNumber=function(){t.post("/order/findOrderByNumber",{storeId:e.$parent.currStore.storeId,orderNumber:e.orderNumber}).success(function(t,o,r,s){if(0==t.statusCode)if(t.data){var n={orderInfo:t.data,from:"posScan"};t.data.orderId&&(n.orderId=t.data.orderId),e.go("order-detail",n)}else e.showComnPopup({message:"订单不存在!",type:"alert"});else e.showComnPopup({message:t.statusMessage,type:"alert"})})},e.$parent.totalCommodityList.length>0&&e.initPosScan()}]),angular.module("xsyh").controller("shoppingCartCtrl",["$scope","$http","$timeout","$ionicScrollDelegate","$ionicModal",function(e,t,o,r,s){e.$on("$ionicView.enter",function(){e.$parent.currFooterMenu=2,e.$parent.shoppingCart.length>0&&(e.refreshCart=function(t){t.checked?(t.itemList.forEach(function(e){e.checked=!0}),1!=t.id&&e.$parent.mealInfoList.forEach(function(e){e.id!=t.id&&1!=e.id&&(e.checked=!1,e.itemList.forEach(function(e){e.checked=!1}))})):t.itemList.forEach(function(e){e.checked=!1})},e.deleteAll=function(){if(e.$parent.shoppingCart.length>0){var t={title:"是否确认删除全部餐品?",type:"confirm"};t.confirm=function(){e.$parent.shoppingCart.forEach(function(e){e.count=0}),e.$parent.shoppingCart=[],e.$parent.mealInfoList.forEach(function(e,t,o){e.itemList=[]}),r.$getByHandle("shoppingCartContent").scrollTop(!1)},e.showComnPopup(t)}})})}]),angular.module("xsyh").controller("storeCtrl",["$scope","$ionicScrollDelegate","$timeout","$http","$stateParams",function(e,t,o,r,s){e.$on("$ionicView.enter",function(){}),e.getNearbyStore=function(t){r.post("/store/nearby",{lat:t.latitude,lng:t.longitude}).success(function(t,o,r,s){0==t.statusCode?(e.nearbyStoreList=[],t.data.forEach(function(t){for(var o=0;o<e.$parent.storeList;o++)if(t.storeId==e.$parent.storeList[o].storeId){e.$parent.storeList[o].distance=t.distance,e.nearbyStoreList.push(e.$parent.storeList[o]);break}})):e.showComnPopup({message:t.statusMessage,type:"alert"})})}}]),!function(e,t){"function"==typeof define&&(define.amd||define.cmd)?define(function(){return t(e)}):t(e,!0)}(this,function(e,t){function o(t,o,r){e.WeixinJSBridge?WeixinJSBridge.invoke(t,s(o),function(e){i(t,e,r)}):d(t,r)}function r(t,o,r){e.WeixinJSBridge?WeixinJSBridge.on(t,function(e){r&&r.trigger&&r.trigger(e),i(t,e,o)}):r?d(t,r):d(t,o)}function s(e){return e=e||{},e.appId=k.appId,e.verifyAppId=k.appId,e.verifySignType="sha1",e.verifyTimestamp=k.timestamp+"",e.verifyNonceStr=k.nonceStr,e.verifySignature=k.signature,e}function n(e){return{timeStamp:e.timestamp+"",nonceStr:e.nonceStr,"package":e["package"],paySign:e.paySign,signType:e.signType||"SHA1"}}function i(e,t,o){var r,s,n;switch(delete t.err_code,delete t.err_desc,delete t.err_detail,r=t.errMsg,r||(r=t.err_msg,delete t.err_msg,r=a(e,r),t.errMsg=r),o=o||{},o._complete&&(o._complete(t),delete o._complete),r=t.errMsg||"",k.debug&&!o.isInnerInvoke&&alert(JSON.stringify(t)),s=r.indexOf(":"),n=r.substring(s+1)){case"ok":o.success&&o.success(t);break;case"cancel":o.cancel&&o.cancel(t);break;default:o.fail&&o.fail(t)}o.complete&&o.complete(t)}function a(e,t){var o,r,s=e,n=$[s];return n&&(s=n),o="ok",t&&(r=t.indexOf(":"),o=t.substring(r+1),"confirm"==o&&(o="ok"),"failed"==o&&(o="fail"),-1!=o.indexOf("failed_")&&(o=o.substring(7)),-1!=o.indexOf("fail_")&&(o=o.substring(5)),o=o.replace(/_/g," "),o=o.toLowerCase(),("access denied"==o||"no permission to execute"==o)&&(o="permission denied"),"config"==s&&"function not exist"==o&&(o="ok"),""==o&&(o="fail")),t=s+":"+o}function c(e){var t,o,r,s;if(e){for(t=0,o=e.length;o>t;++t)r=e[t],s=f[r],s&&(e[t]=s);return e}}function d(e,t){if(!(!k.debug||t&&t.isInnerInvoke)){var o=$[e];o&&(e=o),t&&t._complete&&delete t._complete,console.log('"'+e+'",',t||"")}}function p(){0!=x.preVerifyState&&(C||v||k.debug||"6.0.2">w||x.systemType<0||P||(P=!0,x.appId=k.appId,x.initTime=M.initEndTime-M.initStartTime,x.preVerifyTime=M.preVerifyEndTime-M.preVerifyStartTime,E.getNetworkType({isInnerInvoke:!0,success:function(e){var t,o;x.networkType=e.networkType,t="http://open.weixin.qq.com/sdk/report?v="+x.version+"&o="+x.preVerifyState+"&s="+x.systemType+"&c="+x.clientVersion+"&a="+x.appId+"&n="+x.networkType+"&i="+x.initTime+"&p="+x.preVerifyTime+"&u="+x.url,o=new Image,o.src=t}})))}function u(){return(new Date).getTime()}function l(t){S&&(e.WeixinJSBridge?t():h.addEventListener&&h.addEventListener("WeixinJSBridgeReady",t,!1))}function m(){E.invoke||(E.invoke=function(t,o,r){e.WeixinJSBridge&&WeixinJSBridge.invoke(t,s(o),r)},E.on=function(t,o){e.WeixinJSBridge&&WeixinJSBridge.on(t,o)})}var f,$,h,g,y,I,C,v,S,T,L,w,P,b,M,x,k,A,D,E;return e.jWeixin?void 0:(f={config:"preVerifyJSAPI",onMenuShareTimeline:"menu:share:timeline",onMenuShareAppMessage:"menu:share:appmessage",onMenuShareQQ:"menu:share:qq",onMenuShareWeibo:"menu:share:weiboApp",onMenuShareQZone:"menu:share:QZone",previewImage:"imagePreview",getLocation:"geoLocation",openProductSpecificView:"openProductViewWithPid",addCard:"batchAddCard",openCard:"batchViewCard",chooseWXPay:"getBrandWCPayRequest"},$=function(){var e,t={};for(e in f)t[f[e]]=e;return t}(),h=e.document,g=h.title,y=navigator.userAgent.toLowerCase(),I=navigator.platform.toLowerCase(),C=!(!I.match("mac")&&!I.match("win")),v=-1!=y.indexOf("wxdebugger"),S=-1!=y.indexOf("micromessenger"),T=-1!=y.indexOf("android"),L=-1!=y.indexOf("iphone")||-1!=y.indexOf("ipad"),w=function(){var e=y.match(/micromessenger\/(\d+\.\d+\.\d+)/)||y.match(/micromessenger\/(\d+\.\d+)/);return e?e[1]:""}(),P=!1,b=!1,M={initStartTime:u(),initEndTime:0,preVerifyStartTime:0,preVerifyEndTime:0},x={version:1,appId:"",initTime:0,preVerifyTime:0,networkType:"",preVerifyState:1,systemType:L?1:T?2:-1,clientVersion:w,url:encodeURIComponent(location.href)},k={},A={_completes:[]},D={state:0,data:{}},l(function(){M.initEndTime=u()}),E={config:function(e){k=e,d("config",e);var t=k.check===!1?!1:!0;l(function(){var e,r,s;if(t)o(f.config,{verifyJsApiList:c(k.jsApiList)},function(){A._complete=function(e){M.preVerifyEndTime=u(),D.state=1,D.data=e},A.success=function(){x.preVerifyState=0},A.fail=function(e){A._fail?A._fail(e):D.state=-1};var e=A._completes;return e.push(function(){p()}),A.complete=function(){for(var t=0,o=e.length;o>t;++t)e[t]();A._completes=[]},A}()),M.preVerifyStartTime=u();else{for(D.state=1,e=A._completes,r=0,s=e.length;s>r;++r)e[r]();A._completes=[]}}),k.beta&&m()},ready:function(e){0!=D.state?e():(A._completes.push(e),!S&&k.debug&&e())},error:function(e){"6.0.2">w||b||(b=!0,-1==D.state?e(D.data):A._fail=e)},checkJsApi:function(e){var t=function(e){var t,o,r=e.checkResult;for(t in r)o=$[t],o&&(r[o]=r[t],delete r[t]);return e};o("checkJsApi",{jsApiList:c(e.jsApiList)},function(){return e._complete=function(e){if(T){var o=e.checkResult;o&&(e.checkResult=JSON.parse(o))}e=t(e)},e}())},onMenuShareTimeline:function(e){r(f.onMenuShareTimeline,{complete:function(){o("shareTimeline",{title:e.title||g,desc:e.title||g,img_url:e.imgUrl||"",link:e.link||location.href,type:e.type||"link",data_url:e.dataUrl||""},e)}},e)},onMenuShareAppMessage:function(e){r(f.onMenuShareAppMessage,{complete:function(){o("sendAppMessage",{title:e.title||g,desc:e.desc||"",link:e.link||location.href,img_url:e.imgUrl||"",type:e.type||"link",data_url:e.dataUrl||""},e)}},e)},onMenuShareQQ:function(e){r(f.onMenuShareQQ,{complete:function(){o("shareQQ",{title:e.title||g,desc:e.desc||"",img_url:e.imgUrl||"",link:e.link||location.href},e)}},e)},onMenuShareWeibo:function(e){r(f.onMenuShareWeibo,{complete:function(){o("shareWeiboApp",{title:e.title||g,desc:e.desc||"",img_url:e.imgUrl||"",link:e.link||location.href},e)}},e)},onMenuShareQZone:function(e){r(f.onMenuShareQZone,{complete:function(){o("shareQZone",{title:e.title||g,desc:e.desc||"",img_url:e.imgUrl||"",link:e.link||location.href},e)}},e)},startRecord:function(e){o("startRecord",{},e)},stopRecord:function(e){o("stopRecord",{},e)},onVoiceRecordEnd:function(e){r("onVoiceRecordEnd",e)},playVoice:function(e){o("playVoice",{localId:e.localId},e)},pauseVoice:function(e){o("pauseVoice",{localId:e.localId},e)},stopVoice:function(e){o("stopVoice",{localId:e.localId},e)},onVoicePlayEnd:function(e){r("onVoicePlayEnd",e)},uploadVoice:function(e){o("uploadVoice",{localId:e.localId,isShowProgressTips:0==e.isShowProgressTips?0:1},e)},downloadVoice:function(e){o("downloadVoice",{serverId:e.serverId,isShowProgressTips:0==e.isShowProgressTips?0:1},e)},translateVoice:function(e){o("translateVoice",{localId:e.localId,isShowProgressTips:0==e.isShowProgressTips?0:1},e)},chooseImage:function(e){o("chooseImage",{scene:"1|2",count:e.count||9,sizeType:e.sizeType||["original","compressed"],sourceType:e.sourceType||["album","camera"]},function(){return e._complete=function(e){if(T){var t=e.localIds;t&&(e.localIds=JSON.parse(t))}},e}())},previewImage:function(e){o(f.previewImage,{current:e.current,urls:e.urls},e)},uploadImage:function(e){o("uploadImage",{localId:e.localId,isShowProgressTips:0==e.isShowProgressTips?0:1},e)},downloadImage:function(e){o("downloadImage",{serverId:e.serverId,isShowProgressTips:0==e.isShowProgressTips?0:1},e)},getNetworkType:function(e){var t=function(e){var t,o,r,s=e.errMsg;if(e.errMsg="getNetworkType:ok",t=e.subtype,delete e.subtype,t)e.networkType=t;else switch(o=s.indexOf(":"),r=s.substring(o+1)){case"wifi":case"edge":case"wwan":e.networkType=r;break;default:e.errMsg="getNetworkType:fail"}return e};o("getNetworkType",{},function(){return e._complete=function(e){e=t(e)},e}())},openLocation:function(e){o("openLocation",{latitude:e.latitude,longitude:e.longitude,name:e.name||"",address:e.address||"",scale:e.scale||28,infoUrl:e.infoUrl||""},e)},getLocation:function(e){e=e||{},o(f.getLocation,{type:e.type||"wgs84"},function(){return e._complete=function(e){delete e.type},e}())},hideOptionMenu:function(e){o("hideOptionMenu",{},e)},showOptionMenu:function(e){o("showOptionMenu",{},e)},closeWindow:function(e){e=e||{},o("closeWindow",{},e)},hideMenuItems:function(e){o("hideMenuItems",{menuList:e.menuList},e)},showMenuItems:function(e){o("showMenuItems",{menuList:e.menuList},e)},hideAllNonBaseMenuItem:function(e){o("hideAllNonBaseMenuItem",{},e)},showAllNonBaseMenuItem:function(e){o("showAllNonBaseMenuItem",{},e)},scanQRCode:function(e){e=e||{},o("scanQRCode",{needResult:e.needResult||0,scanType:e.scanType||["qrCode","barCode"]},function(){return e._complete=function(e){var t,o;L&&(t=e.resultStr,t&&(o=JSON.parse(t),e.resultStr=o&&o.scan_code&&o.scan_code.scan_result))},e}())},openProductSpecificView:function(e){o(f.openProductSpecificView,{pid:e.productId,view_type:e.viewType||0,ext_info:e.extInfo},e)},addCard:function(e){var t,r,s,n,i=e.cardList,a=[];for(t=0,r=i.length;r>t;++t)s=i[t],n={card_id:s.cardId,card_ext:s.cardExt},a.push(n);o(f.addCard,{card_list:a},function(){return e._complete=function(e){var t,o,r,s=e.card_list;if(s){for(s=JSON.parse(s),t=0,o=s.length;o>t;++t)r=s[t],r.cardId=r.card_id,r.cardExt=r.card_ext,r.isSuccess=r.is_succ?!0:!1,delete r.card_id,delete r.card_ext,delete r.is_succ;e.cardList=s,delete e.card_list}},e}())},chooseCard:function(e){o("chooseCard",{app_id:k.appId,location_id:e.shopId||"",sign_type:e.signType||"SHA1",card_id:e.cardId||"",card_type:e.cardType||"",card_sign:e.cardSign,time_stamp:e.timestamp+"",nonce_str:e.nonceStr},function(){return e._complete=function(e){e.cardList=e.choose_card_info,delete e.choose_card_info},e}())},openCard:function(e){var t,r,s,n,i=e.cardList,a=[];for(t=0,r=i.length;r>t;++t)s=i[t],n={card_id:s.cardId,code:s.code},a.push(n);o(f.openCard,{card_list:a},e)},chooseWXPay:function(e){o(f.chooseWXPay,n(e),e)}},t&&(e.wx=e.jWeixin=E),E)});